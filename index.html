<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#2e7d32" />
  <title>Freeman Lawn Services LLC</title>

  <!-- PWA basics -->
  <link rel="manifest" href="/manifest.json">

  <!-- Recommended for better iOS standalone experience -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Freeman Lawn">

  <!-- Styles -->
  <link rel="stylesheet" href="css/app.css">
</head>
<body>

  <!-- Login -->
  <main class="wrap" id="loginWrap">
    <section class="card">
      <h1>Freeman Lawn Services</h1>
      <p class="sub">Enter your 4-digit PIN</p>
      <input id="pinInput" class="pin" type="password" maxlength="4" inputmode="numeric" />
      <button id="setPinBtn" class="btn btn-secondary" type="button">ğŸ”’ Set PIN</button>
    </section>
  </main>

  <!-- Schedule -->
  <section id="scheduleView" class="page">
    <h1>Weekly Schedule</h1>
    <div id="scheduleDays"></div>
  </section>

  <!-- Clients -->
  <section id="clientsView" class="page">
    <h1>Clients</h1>
    <div class="client-controls">
      <input type="text" id="clientSearch" class="input" placeholder="ğŸ” Search clients...">
      <select id="clientSort" class="input">
        <option value="name">Name</option>
        <option value="serviceDay">Service Day</option>
        <option value="status">Payment Status</option>
        <option value="rate">Monthly Rate</option>
      </select>
    </div>
    <button onclick="toggleClientForm()" class="btn btn-primary" style="width:100%; margin-bottom:12px;">â• Add Client</button>

    <div id="clientFormWrap" style="display:none; margin-bottom:16px;">
      <form id="clientForm">
        <input type="hidden" id="clientId">
        <input type="hidden" id="clientPhoto">
        <input type="hidden" id="clientGallery">

        <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
          <button type="button" class="btn btn-primary" id="btnTakeProfile">ğŸ“· Take photo</button>
          <button type="button" class="btn btn-secondary" id="btnUploadProfile">ğŸ–¼ï¸ Upload photo</button>
        </div>
        <input type="file" id="clientPhotoFile_camera" accept="image/*" capture="environment" hidden>
        <input type="file" id="clientPhotoFile_upload" accept="image/*" hidden>
        <img id="clientPhotoPreview" style="max-width:100px; border-radius:8px; display:none; margin-bottom:8px;">
        <button type="button" class="btn btn-danger" id="btnRemoveProfile" style="display:none;">âŒ Remove profile photo</button>

        <div style="display:flex; gap:8px; margin:8px 0; flex-wrap:wrap;">
          <button type="button" class="btn btn-primary" id="btnTakeGallery">ğŸ“· Take photo(s)</button>
          <button type="button" class="btn btn-secondary" id="btnUploadGallery">ğŸ–¼ï¸ Upload photo(s)</button>
        </div>
        <input type="file" id="clientGalleryFiles_camera" accept="image/*" capture="environment" hidden>
        <input type="file" id="clientGalleryFiles_upload" accept="image/*" multiple hidden>
        <div id="clientGalleryPreview" style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px;"></div>

        <input type="text" id="clientName" class="input" placeholder="Client Name" required>
        <input type="text" id="clientAddress" class="input" placeholder="Address" required>
        <input type="tel" id="clientPhone" class="input" placeholder="Phone Number">
        <input type="email" id="clientEmail" class="input" placeholder="Email">

        <select id="clientPickup" class="input">
          <option value="">Horticulture Pickup Day</option>
          <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
          <option>Thursday</option><option>Friday</option><option>Saturday</option>
        </select>

        <select id="clientServiceDay" class="input">
          <option value="">Service Day</option>
          <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
          <option>Thursday</option><option>Friday</option><option>Saturday</option>
        </select>

        <select id="clientFrequency" class="input">
          <option value="Weekly">Weekly</option>
          <option value="Bi-Weekly">Bi-Weekly</option>
        </select>

        <input type="number" id="clientRate" class="input" placeholder="Monthly Rate ($)">
        <select id="clientStatus" class="input">
          <option value="Paid">Paid</option>
          <option value="Pending">Pending</option>
          <option value="Overdue">Overdue</option>
        </select>

        <input type="text" id="clientBillingName" class="input" placeholder="Billing Name">
        <input type="text" id="clientBillingAddress" class="input" placeholder="Billing Address">

        <label style="display:block;">Start Month/Year:
          <input type="month" id="clientStart" class="input">
        </label>

        <label class="switch">
          <input type="checkbox" id="clientPaused">
          <span class="slider"></span>
        </label> Pause Service

        <textarea id="clientNotes" class="input" placeholder="Notes"></textarea>
        <button type="submit" class="btn btn-primary" style="width:100%;">ğŸ’¾ Save Client</button>
        <button type="button" onclick="cancelEdit()" class="btn btn-secondary" style="width:100%; margin-top:8px;">Cancel</button>
      </form>
    </div>

    <div id="clientList"></div>
  </section>

  <!-- Invoices -->
  <section id="invoicesView" class="page">
    <h1>Invoices</h1>
    <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
      <input id="invMonth" type="month" class="input" style="max-width:220px;">
      <button class="btn btn-primary" onclick="generateInvoicesForSelected()">ğŸ§¾ Generate (manual)</button>
      <button class="btn btn-secondary" onclick="clearUnpaidForMonth()">ğŸ—‘ Clear Unpaid</button>
      <button class="btn btn-primary" onclick="bulkSmsUnpaid()">ğŸ“² SMS unpaid</button>
      <button class="btn btn-secondary" onclick="bulkEmailUnpaid()">âœ‰ï¸ Email unpaid</button>
    </div>
    <div id="invoiceTotals" style="margin:8px 0; font-weight:600;"></div>
    <div id="invoiceList"></div>
    <p style="color:#555; font-size:.9rem; margin-top:8px;">Tip: Invoices auto-generate and turn overdue automatically based on your settings.</p>
  </section>

  <!-- Settings -->
  <section id="settingsView" class="page">
    <h1>Settings</h1>

    <div class="day-card">
      <h2>Data Backup</h2>
      <p class="subtle">Export everything into one JSON, or import from a backup.</p>
      <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="exportAllData()">â¬‡ï¸ Export All</button>
        <input id="importAllFile" type="file" accept=".json" style="display:none;">
        <button class="btn btn-secondary" onclick="document.getElementById('importAllFile').click()">â¬†ï¸ Import All</button>
      </div>
      <p style="font-size:.9rem; color:#555;">Exports clients, invoices, route orders (order_Mondayâ€¦), and automation settings into one JSON.</p>
    </div>

    <div class="day-card">
      <h2>Business Profile</h2>
      <p class="subtle">Used on invoices and messages. Keep this up to date.</p>
      <div class="grid-2">
        <input id="bp_name" class="input" placeholder="Business name">
        <input id="bp_owner" class="input" placeholder="Owner">
        <textarea id="bp_address" class="input" placeholder="Address"></textarea>
        <input id="bp_email" class="input" placeholder="Email">
        <input id="bp_phone" class="input" placeholder="Phone">

        <div class="grid-2">
          <input id="bp_venmo" class="input" placeholder="Venmo (e.g. @FreemanLawnFL)">
          <input id="bp_cashapp" class="input" placeholder="Cash App (e.g. $FreemanLawnFL)">
        </div>

        <div class="grid-3">
          <input id="bp_zelle_name" class="input" placeholder="Zelle name">
          <input id="bp_zelle_phone" class="input" placeholder="Zelle phone">
          <input id="bp_zelle_email" class="input" placeholder="Zelle email">
        </div>

        <button class="btn btn-primary" onclick="saveBusinessProfile()">ğŸ’¾ Save Business Profile</button>
      </div>
    </div>

    <div class="day-card">
      <h2>Invoicing Automation</h2>
      <p class="subtle">Set it and forget it â€” invoices create automatically and can be marked overdue.</p>
      <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
        <label class="switch" title="Enable automatic monthly invoice generation">
          <input type="checkbox" id="autoInvoiceToggle">
          <span class="slider"></span>
        </label>
        <span>Enable auto-generate</span>

        <div>
          <label for="autogenDay" style="font-weight:600;">Day of month</label><br/>
          <select id="autogenDay" class="input" style="width:120px; margin:6px 0 0;"></select>
        </div>

        <button class="btn btn-primary" onclick="runMonthlyAutogenNow()">âš¡ Run this month now</button>
      </div>

      <hr style="border:none; border-top:1px solid #eee; margin:12px 0;">

      <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
        <label class="switch" title="Automatically mark invoices as Overdue after N days">
          <input type="checkbox" id="autoOverdueToggle">
          <span class="slider"></span>
        </label>
        <span>Auto-mark Overdue</span>

        <div>
          <label for="overdueDays" style="font-weight:600;">Days after creation</label><br/>
          <input id="overdueDays" type="number" min="1" max="60" step="1" class="input" style="width:110px; margin-top:6px;">
        </div>

        <button class="btn btn-secondary" onclick="runOverdueCheckNow()">â± Run overdue check now</button>
      </div>

      <p id="autoSummary" class="hint"></p>
    </div>

    <div class="day-card">
      <h2>Security</h2>
      <p class="subtle">Protect your data with a 4-digit PIN.</p>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-secondary" onclick="changePin()">ğŸ”’ Change PIN</button>
        <button class="btn btn-secondary" onclick="removePin()">ğŸ”“ Remove PIN</button>
      </div>
    </div>

    <div class="day-card danger">
      <h2>Danger Zone</h2>
      <p class="subtle">This clears ALL local data (clients, invoices, routes, settings, PIN).</p>
      <button class="btn btn-danger" onclick="wipeAllData()">ğŸ—‘ Reset All Data</button>
    </div>

    <!-- Added Install App button here -->
    <div class="day-card">
      <h2>Install the App</h2>
      <p class="subtle">Add Freeman Lawn to your home screen for full app experience (offline support, no browser bar).</p>
      <button id="installBtn" class="btn btn-primary" style="display:none; width:100%; margin-top:8px;">
        Install App
      </button>
    </div>

    <p id="aboutMeta" style="margin-top:12px; font-size:.9rem; color:#555;"></p>
  </section>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav" id="bottomNav" style="display:none;">
    <button onclick="showPage('scheduleView')" id="navSchedule">ğŸ—“ Schedule</button>
    <button onclick="showPage('clientsView')" id="navClients">ğŸ‘¥ Clients</button>
    <button onclick="showPage('invoicesView')" id="navInvoices">ğŸ’µ Invoices</button>
    <button onclick="showPage('settingsView')" id="navSettings">âš™ï¸ Settings</button>
  </nav>

  <!-- Bulk SMS panel -->
  <div id="bulkPanel" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:2000;">
    <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(92vw,520px); background:#fff; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.3);">
      <h3 style="margin:0 0 8px; color:#1f5a24;">Send SMS to unpaid</h3>
      <p id="bulkPanelSubtitle" style="margin:0 0 10px; color:#555; font-size:.9rem;"></p>
      <div id="bulkPanelList" style="max-height:48vh; overflow:auto; border:1px solid #eee; border-radius:12px; padding:8px;"></div>
      <div style="display:flex; gap:8px; margin-top:12px;">
        <button class="btn btn-primary" onclick="closeBulkPanel()">Close</button>
        <button class="btn btn-secondary" onclick="copyBulkEmail()">Copy email list</button>
      </div>
    </div>
  </div>

  <!-- Custom PIN Modal (for Set PIN and Change PIN) -->
  <div id="pinModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:16px; padding:24px; width:88%; max-width:340px; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
      <h2 id="pinModalTitle" style="margin:0 0 8px; color:var(--green-dark);">Set New PIN</h2>
      <p id="pinModalSub" style="margin:0 0 16px; color:#555;">Enter 4 digits</p>
      <input id="modalPin" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="4" style="width:100%; font-size:32px; text-align:center; letter-spacing:12px; padding:12px; border:2px solid #cfd8dc; border-radius:12px; margin-bottom:16px;" />
      <div style="display:flex; gap:12px;">
        <button id="cancelPin" class="btn btn-secondary" style="flex:1;">Cancel</button>
        <button id="confirmPinBtn" class="btn btn-primary" style="flex:1;">Save</button>
      </div>
    </div>
  </div>

  <script type="module" src="js/app.js"></script>
</body>
</html>
